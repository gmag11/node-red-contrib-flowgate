<script type="text/html" data-template-name="flowgate">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
    <div class="form-row" id="node-input-bypass-enable">
        <label>Bypass</label>
        <input type="checkbox" id="node-input-bypass" style="margin-left:0px; vertical-align:top; width:auto !important;">
        <label for="node-input-bypass" style="width:auto">Use bypass output</label>
    </div>
    <div class="form-row">
        <input type="hidden" id="node-input-outputs" value="1" min="1" max="2"/>
    </div>
</script>

<script type="text/javascript">
    (function () {
        function activateAjaxCall(node, active, successCallback) {
            var url = "flowgate/" + node.id + "/" + (active ? "enable" : "disable");
            $.ajax({
                url: url,
                type: "POST",
                success: successCallback,
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.status == 404) {
                        RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                    } else if (jqXHR.status === 0) {
                        RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                    } else {
                        RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                    }
                }
            });
        }

        RED.nodes.registerType('flowgate', {
            category: 'function',
            color: '#e2d96e',
            defaults: {
                name: { value: "" },
                bypass: { value: false },
                outputs: { value: 1 },
                active: { value: true }
            },
            inputs: 1,
            icon: "font-awesome/fa-power-off",
            label: function () {
                return this.name || "flowgate";
            },
            outputs: 1,
            oneditsave: function() {
                var bypassEnabled = $("#node-input-bypass").is(":checked");
                $("#node-input-outputs").val(bypassEnabled ? "2" : "1");
                var outputs = $("#node-input-outputs").val();
                this.outputs = parseInt(outputs);  
            },
            button: {
                toggle: "active",
                onclick: function () {
                    var label = RED.utils.sanitize(this.name || "flowgate");
                    var node = this;
                    activateAjaxCall(node, node.active, function (resp, textStatus, xhr) {
                        var historyEvent = {
                            t: 'edit',
                            node: node,
                            changes: {
                                active: !node.active
                            },
                            dirty: node.dirty,
                            changed: node.changed,
                            callback: function (ev) {
                                activateAjaxCall(ev.node, ev.node.active);
                            }
                        };
                        node.changed = true;
                        //node.dirty = true;
                        RED.nodes.dirty(true);
                        RED.history.push(historyEvent);
                        //if (xhr.status == 200) {
                            //RED.notify(node._("debug.notification.activated", { label: label }), { type: "success", timeout: 2000 });
                        //} else if (xhr.status == 201) {
                            //RED.notify(node._("debug.notification.deactivated", { label: label }), { type: "success", timeout: 2000 });
                        //}
                        //node.dirty = true;
                        RED.view.redraw();
                    });
                }
            },
        });
    })();
</script>

<script type="text/markdown" data-help-name="flowgate">
This custom Node-RED node controls message flow in automation workflows during development. It allows messages to pass when active and blocks them when inactive, without deployment.

### Inputs

The full input message to be controlled by the FlowGate node.

: flowgate ( boolean | string | number ) : The FlowGate node can be activated or deactivated by setting the value of this property to true or false. Alternatively, it can be activated or deactivated by setting it to 1 or 0, "ON" or "OFF". This property is removed before the message is passed to the active output.

### Outputs

1. Active output
: The message is passed through when the FlowGate node is active.

2. Bypass output (optional)
: The message is passed through when the FlowGate node is inactive and the Bypass option is enabled.

### Details

`msg` is the input message. It is passed by default to the active output when the FlowGate node is active. 
When the FlowGate node is inactive, the Bypass output can be used to pass the message through.
This can be useful for debugging for isolating specific parts of a flow.

### Configuration

- **Name**: A name for the FlowGate node to help identify it in your flows.
- **Bypass**: Enables the Bypass output to pass the message through when the FlowGate node is inactive.

### Note

It is not recommended to use this node in production environments as this breaks the Node-RED recommendation about [buttons](https://nodered.org/docs/creating-nodes/appearance#buttons)


</script>

<style>
    .form-row {
        margin-bottom: 10px;
    }

    .red-ui-flow-node-button-toggle {
        position: absolute;
        right: 0;
        top: 0;
        width: 30px;
        height: 30px;
        background-color: #ccc;
        border-radius: 15px;
        cursor: pointer;
    }

    .red-ui-flow-node-button-toggle.active {
        background-color: #4caf50;
    }
</style>