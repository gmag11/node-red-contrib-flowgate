<script type="text/html" data-template-name="flowgate">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
    <div class="form-row" id="node-input-bypass-enable">
        <label>Bypass</label>
        <input type="checkbox" id="node-input-bypass" style="margin-left:0px; vertical-align:top; width:auto !important;">
        <label for="node-input-bypass" style="width:auto">Use bypass output</label>
    </div>
    <div class="form-row">
        <input type="hidden" id="node-input-outputs" />
    </div>
</script>

<script type="text/javascript">
    (function () {
        function activateAjaxCall(node, active, successCallback) {
            var url = "flowgate/" + node.id + "/" + (active ? "enable" : "disable");
            $.ajax({
                url: url,
                type: "POST",
                success: successCallback,
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.status == 404) {
                        RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                    } else if (jqXHR.status === 0) {
                        RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                    } else {
                        RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                    }
                }
            });
        }

        RED.nodes.registerType('flowgate', {
            category: 'function',
            color: '#e2d96e',
            defaults: {
                name: { value: "" },
                bypass: { value: false },
                outputs: { value: 1 },
                active: { value: true }
            },
            inputs: 1,
            icon: "font-awesome/fa-power-off",
            label: function () {
                return this.name || "flowgate";
            },
            outputs: 1,
            oneditprepare: function () {
                var node = this;
                if (this.bypass === "true" || this.bypass === true) {
                    $("#node-input-bypass").prop("checked", true);
                } else {
                    $("#node-input-bypass").prop("checked", false);
                }
                $("#node-input-bypass").on("change", function () {
                   node.bypass = $(this).is(":checked");
                   node.outputs = node.bypass ? 2 : 1;
                });
                // Ajustar el número de salidas al cargar la interfaz de edición
                //node.outputs = node.bypass ? 2 : 1;
            },
            oneditsave: function () {
                // Guardar el estado del botón
                var node = this;
                node.bypass = $("#node-input-bypass").is(":checked");
                node.outputs = node.bypass ? 2 : 1;
                node.redraw();
                //this.changed = true;
                //this.dirty = true;
                //RED.nodes.dirty(true);
            },
            button: {
                toggle: "active",
                onclick: function () {
                    var label = RED.utils.sanitize(this.name || "flowgate");
                    var node = this;
                    activateAjaxCall(node, node.active, function (resp, textStatus, xhr) {
                        var historyEvent = {
                            t: 'edit',
                            node: node,
                            changes: {
                                active: !node.active
                            },
                            dirty: node.dirty,
                            changed: node.changed,
                            callback: function (ev) {
                                activateAjaxCall(ev.node, ev.node.active);
                            }
                        };
                        node.changed = true;
                        node.dirty = true;
                        RED.nodes.dirty(true);
                        RED.history.push(historyEvent);
                        if (xhr.status == 200) {
                            //RED.notify(node._("debug.notification.activated", { label: label }), { type: "success", timeout: 2000 });
                        } else if (xhr.status == 201) {
                            //RED.notify(node._("debug.notification.deactivated", { label: label }), { type: "success", timeout: 2000 });
                        }
                        node.dirty = true;
                        RED.view.redraw();
                    });
                }
            },
            onpaletteadd: function () {
                var options = {
                    messageMouseEnter: function (sourceId) {
                        if (sourceId) {
                            var n = RED.nodes.node(sourceId);
                            if (n) {
                                n.highlighted = true;
                                n.dirty = true;
                            }
                            RED.view.redraw();
                        }
                    },
                    messageMouseLeave: function (sourceId) {
                        if (sourceId) {
                            var n = RED.nodes.node(sourceId);
                            if (n) {
                                n.highlighted = false;
                                n.dirty = true;
                            }
                            RED.view.redraw();
                        }
                    }
                };
            }
        });

        // Código que se ejecuta justo después de registrar el nodo
        // $(document).ready(function () {
        //     console.log("Flowgate node type registered successfully.");
        //     // Adaptar el número de salidas según el valor del bypass
        //     $(".red-ui-palette-node[data-palette-type='flowgate']").each(function () {
        //         var node = RED.nodes.node($(this).data('node-id'));
        //         if (node && node.bypass) {
        //             node.outputs = 2;
        //         } else {
        //             node.outputs = 1;
        //         }
        //     });
        // });
    })();
</script>

<style>
    .form-row {
        margin-bottom: 10px;
    }

    .red-ui-flow-node-button-toggle {
        position: absolute;
        right: 0;
        top: 0;
        width: 30px;
        height: 30px;
        background-color: #ccc;
        border-radius: 15px;
        cursor: pointer;
    }

    .red-ui-flow-node-button-toggle.active {
        background-color: #4caf50;
    }
</style>